<template>
  <view>
    <view class="cover" hidden="{{!showModal}}" animation="{{coverAnimation}}">
    </view>
    <view class="cover-modal" hidden="{{!showModal}}">
      <view style="color:#353535;margin:40rpx 25rpx 20rpx 25rpx">å½“æ¬ è´¹æ»¡10å…ƒæ—¶è¿˜ä¹¦è‡ªåŠ¨æ‰£æ¬¾ï¼Œè‹¥æ¬ è´¹æœªæ»¡10å…ƒå°†åœ¨æ¯•ä¸šå‰ç»“æ¸…ã€‚ä½ ä¹Ÿå¯ä»¥å‰å¾€å›¾ä¹¦é¦†è‡ªè¡Œç¼´è´¹ã€‚</view>
      <view style="height:2rpx;width:540rpx;background:#E3E3E3;margin-left:-20rpx"></view>
      <view style="color:#39C9FF;margin-top:5rpx;padding-top:30rpx" @tap="understandTip">çŸ¥é“äº†</view>
    </view>
    <QyModal :maskClosable="maskClosable" width="500rpx" :visible.sync="bindModalVisible">
      <view slot="content" class="bind-container">
        <input class="bind-input" placeholder="{{placeholder}}" password="true" @input="bindCardPassword" placeholder-style="color: #999CA0" />
        <button class="bind-button" @tap.stop="bindHandle" hover-class="button-click">ç«‹å³ç»‘å®š</button>
      </view>
    </QyModal>
    <!-- <navigator style="text-align:center;"> {{navTitle}} </navigator> -->
    <!-- <qy-container> -->
      <!-- <view slot="qy-content"> -->
        <view class="swiper-tab">
          <view class="swiper-tab-list {{currentTab==0?'active':''}}" data-current="0" @tap="switchNav">å·²å€Ÿä¹¦ç›®</view>
          <view class="swiper-tab-list {{currentTab==1?'active':''}}" data-current="1" @tap="switchNav">ä¹¦ç›®æ£€ç´¢</view>
          <view class="swiper-tab-list {{currentTab==2?'active':''}}" data-current="2" @tap="switchNav">åº§ä½æŸ¥è¯¢</view>
          <view animation="{{animationNav}}" class="swiper-line"></view>
        </view>
        <swiper id="hhh" class="swiper-box" current="{{currentTab}}" duration="500" display-multiple-items="1" style="height:{{winHeight-38}}px" bindchange="changeTab">
          <!-- å·²å€Ÿä¹¦ç›® -->
          <swiper-item>
            <view class="books-container">
              <scroll-view scroll-y="true" enable-back-to-top="true" style="height:{{winHeight-38}}px">
                <view class="books-head" style="margin-bottom:{{arrears==0?'80rpx':'0'}}">
                  <view class="books-num">
                    {{totalBooksNumber}}
                  </view>
                  <view class="books-cnt">
                    æ¬¡
                  </view>
                </view>
                <view wx:if="{{arrears!=0}}" class="books-tip" @tap="showBooksTip">
                  ä½ å·²æ¬ è´¹{{arrears}}å…ƒ
                  <image class="books-question" src="https://static.airbob.org/under-graduate/library_pic_why.png" />
                </view>
                <view wx:if="{{curBooksNum==0}}" class="books-none-container">
                  <image class="books-none-img" src="https://static.airbob.org/under-graduate/pic_empty.png" />
                  <view>ä½ å½“å‰æ²¡æœ‰å€Ÿä¹¦ï¼Œå¿«å»å›¾ä¹¦é¦†æ·˜ä¸€æ·˜ï¼</view>
                </view>
                <view class="books-list" wx:if="{{curBooksNum>0}}">
                  <repeat for="{{lendBooks}}" key="key" index="index" item="item">
                    <view class="book-container" style="border-bottom-left-radius:{{isTapIndex[index]? '0rpx' : '20rpx'}};border-bottom-right-radius:{{isTapIndex[index]? '0rpx' : '20rpx'}};border-bottom:{{isTapIndex[index]? 'none' : '1rpx solid rgba(0,0,0,0.1)'}};">
                      <view class="book-info-all">
                        <view class="book-name">
                          {{item.bookname}}
                        </view>
                        <view class="book-info">å·²ç»­å€Ÿ{{item.renew}}æ¬¡</view>
                        <view class="book-info" style="white-space:nowrap">åº”è¿˜æ—¥æœŸï¼š{{item.DDL}} <span style="color:#FFB737" wx:if="{{item.leftDDL<=10&&item.leftDDL>=0}}">æ®å½’è¿˜è¿˜æœ‰{{item.leftDDL}}å¤©ï¼Œè¯·åŠæ—¶å½’è¿˜ï¼</span></view>
                      </view>
                      <image data-index="{{index}}" data-name="{{item.marc_no}}" class="button-updown" src="https://static.airbob.org/under-graduate/image/score/button_down.png" @tap="{{hide[index]? 'showBookDetails' : 'hideBookDetails'}}"  animation="{{spin[index]}}"/>
                    </view>
                    <view class="book-detail-container" animation="{{showOff[index]}}" style="border-bottom:{{isTapIndex[index]? '1rpx solid rgba(0,0,0,0.1)' : 'none'}};">
                      <view class="book-detail-info-all" id="lendbook{{index}}">
                        <view class="book-info">ä¹¦å: {{item.bookname}}</view>
                        <view class="book-info">ä½œè€…: {{item.author}}</view>
                        <view class="book-info">å‡ºç‰ˆç¤¾: {{item.publishers}}</view>
                        <view class="book-info">æ‰€å±åˆ†ç±»: {{item.category}}</view>
                        <view class="book-info">ISBN: {{item.ISBN}}</view>
                        <view class="book-info">ä»·æ ¼: {{item.price}}</view>
                        <view class="book-info">ç®€ä»‹: {{item.summary}}</view>
                      </view>
                    </view>
                  </repeat>
                </view>
                <view wx:if="{{curBooksNum>0}}" class="button-renew" style="background-image:url({{renewAll?renewbtn.highlight:renewbtn.disabled}});" @tap="renewBooks">
                  ä¸€é”®ç»­å€Ÿ
                </view>
              </scroll-view>
            </view>
          </swiper-item>
          <!-- ä¹¦ç›®æ£€ç´¢ -->
          <swiper-item>
            <view class="search-container">
              <scroll-view scroll-y="true" enable-back-to-top="true" style="height:{{winHeight-38}}px" bindscrolltolower="loadMoreBooks">
                <view class="search-bar-container">
                  <view class="search-bar">
                    <view class="search-placeholder-all" hidden="{{hasInput}}" @tap="clearPlaceHolder">
                      <image src="https://static.airbob.org/under-graduate/%E6%90%9C%E7%B4%A2.png" class="search-icon"/>
                      <view class="search-placeholder">è¾“å…¥ä¹¦å/ä½œè€…/å…³é”®è¯</view>
                    </view>
                    <input type="text" class="search-input" confirm-type="search" focus="{{hasInput}}" @input="search" value="{{key}}" bindconfirm="confirmSearch"/>
                  </view>
                </view>
                <view class="search-recommend" hidden="{{emptyResult||hasResult}}">
                  <view class="search-recommend-title">
                    çƒ­é—¨æ¨è
                  </view>
                  <view class="search-recommend-content">
                    <repeat for="{{recomends}}" key="key" index="index" item="book">
                      <view class="search-recommend-book" @tap="quickSearch" data-name="{{book.name}}">
                        {{book.name}}
                      </view>
                    </repeat>
                  </view>
                </view>
                <view class="search-no-result" style="display:{{emptyResult?'flex':'none'}};flex-direction column;">
                  <image class="search-no-result-pic" src="https://static.airbob.org/under-graduate/pic_empty.png" />
                  <view class="search-no-result-tips">æ²¡æœ‰æ‰¾åˆ°è¿™æœ¬ä¹¦ï¼Œä½ å¯ä»¥æ¨èå›¾ä¹¦é¦†è´­ä¹°å“¦</view>
                  <view class="search-no-result-recom" @tap="goToRecomened">è¿›è¡Œè¯»è€…èè´­</view>
                </view>
                <view class="search-result" hidden="{{!hasResult}}">
                  <repeat for="{{searchResult}}" key="key" index="index" item="item">
                    <view class="search-result-container" style="border-bottom-left-radius:{{isTapIndexS[index]? '0rpx' : '20rpx'}};border-bottom-right-radius:{{isTapIndexS[index]? '0rpx' : '20rpx'}};border-bottom:{{isTapIndexS[index]? 'none' : '1rpx solid rgba(0,0,0,0.1)'}}">
                      <view class="search-info-all">
                        <view class="search-book-name">
                          {{item.bookname}}
                        </view>
                        <view class="search-info-item">ä½œè€…: {{item.author}}</view>
                        <view class="search-info-item">å‡ºç‰ˆç¤¾: {{item.publishers}}</view>
                        <view class="search-info-item">ç´¢ä¹¦å·: {{item.callno}}</view>
                        <view class="search-info-item">å¯å€Ÿæœ¬æ•°: {{item.leftBookNum}}</view>
                      </view>
                      <image data-index="{{index}}" data-name="{{item.marc_no}}" class="search-button-updown" src="https://static.airbob.org/under-graduate/image/score/button_down.png" @tap="{{hideS[index]? 'showSearchedBookDetails' : 'hideSearchedBookDetails'}}" animation="{{spinS[index]}}"/>
                    </view>
                    <view class="search-detail-container" animation = "{{showOffS[index]}}" style="border-bottom:{{isTapIndexS[index]? '1rpx solid rgba(0,0,0,0.1)' : 'none'}}">
                      <view class="search-detail-info-all" id="searchbook{{index}}">
                        <repeat for="{{item.positionDetail}}" key="key" item="item">
                          <view class="search-info-item">å›¾ä¹¦ä½ç½®: {{item.position}}</view>
                          <view class="search-info-item">ç´¢ä¹¦å·: {{item.callno}}</view>
                          <view class="search-info-item">çŠ¶æ€: {{item.status}}</view>
                          <view style="height:20rpx; width: 590rpx"></view>
                        </repeat>
                        <view class="search-info-divide"></view>
                        <view class="search-info-item">æ‰€å±åˆ†ç±»: {{item.category}}</view>
                        <view class="search-info-item">ISBN: {{item.ISBN}}</view>
                        <view class="search-info-item">ä»·æ ¼: {{item.price}}</view>
                        <view class="search-info-item">ç®€ä»‹: {{item.summary}}</view>
                      </view>
                    </view>
                  </repeat>
                </view>
              </scroll-view>
            </view>
          </swiper-item>
          <!-- åº§ä½æŸ¥è¯¢ -->
          <swiper-item>
            <view class="seats-container">
              <scroll-view scroll-y="true" enable-back-to-top="true" style="height:{{winHeight-38}}px">
                <view class="seats-head"></view>
                <view class="seats-divide"></view>
                <view class="seats-body">
                  <repeat for="{{floors}}" key="key" index="index" item="item">
                    <seats-card :lib.sync="item"></seats-card>
                  </repeat>
                </view>
              </scroll-view>
            </view>
          </swiper-item>
        </swiper>
      <!-- </view> -->
    <!-- </qy-container> -->
  </view>
</template>

<script>
import wepy from "wepy";
import {
  librarySearch,
  alreadyBorrowBooksSum,
  historicalBorrow,
  bookArrears,
  remainSeats,
  hotBooks,
  bookStore,
  bookStoreAgain,
  bookStoreContent
} from "@/api/library";
import navigation from "@/components/qy-navigation";
import container from "@/components/qy-container";
import QyModal from "@/components/qy-modal";
import seatsCard from "../../components/seats-card";
import { changeSecretCode } from "@/api/common";

export default class Library extends wepy.page {
  config = {
    navigationBarTitleText: "å›¾ä¹¦é¦†"
  };
  components = {
    "qy-navigation": navigation,
    "qy-container": container,
    "seats-card": seatsCard,
    QyModal
  };
  data = {
    navTitle: "å›¾ä¹¦é¦†",
    token: "",
    phoneNumber: "",
    studentId: "",
    bindModalVisible: false,
    bindInputPassword: "",
    userInfo: {},
    winWidth: 0,
    winHeight: 0,
    currentTab: 0,
    arrears: 0,
    totalBooksNumber: 0,
    curBooksNum: 0,
    searchedPage: 0,
    showModal: false,
    isTapIndex: [],
    hide: [],
    isTapIndexS: [],
    hideS: [],
    animationNav: {},
    coverAnimation: {},
    showOff: [],
    spin: [],
    showOffS: [],
    spinS: [],
    // ä¸€ä»¶ç»­å€Ÿåˆå§‹çŠ¶æ€ä¸ºå¯ä¸å¯ç‚¹å‡»
    renewAll: false,
    hasInput: false,
    hasResult: false,
    emptyResult: false,
    renewbtn: {
      highlight:
        "https://static.airbob.org/under-graduate/btn_next_highlight.png",
      disabled: "https://static.airbob.org/under-graduate/btn_next_disable.png"
    },
    lendBooks: [],
    recomends: [],
    searchResult: [],
    searchBookName: "",
    floors: [
      {
        floor: "äºŒ",
        rooms: []
      },
      {
        floor: "ä¸‰",
        rooms: []
      },
      {
        floor: "å››",
        rooms: []
      },
      {
        floor: "äº”",
        rooms: []
      }
    ],
    placeholder: ""
  };
  methods = {
    switchNav(e) {
      let chosen = e.target.dataset.current;
      let cur = this.data.currentTab.toString();
      if (chosen === cur) {
        return false;
      } else {
        this.currentTab = chosen;
      }
      this.$apply();
    },
    changeTab(e) {
      this.currentTab = e.detail.current;
      if (this.currentTab === 1) {
        this.getHotRecommandBooks();
      }
      if (this.currentTab === 0) {
        this.onLoadRequests();
      }
      if (this.currentTab === 2) {
        this.queryOverplusSeats();
      }
      this.$apply();
    },
    async showBooksTip() {
      let that = this;
      function go() {
        return new Promise((resolve, reject) => {
          resolve((that.showModal = true));
        });
      }
      await go();
      let coverAnimation = wepy.createAnimation({
        duration: 500
      });
      coverAnimation.opacity(0.5).step();
      that.coverAnimation = coverAnimation.export();
      that.$apply();
    },
    understandTip(e) {
      let coverAnimation = wepy.createAnimation({
        duration: 0
      });
      coverAnimation.opacity(0).step();
      this.coverAnimation = coverAnimation.export();
      this.showModal = false;
      this.$apply();
    },
    loadMoreBooks(e) {
      if (this.searchResult.length !== 0) {
        wepy.showLoading({
          title: "åŠ è½½ä¸­"
        });
        this.searchedPage++;
        bookStore(this.searchBookName, this.searchedPage).then(res => {
          let results = res.data.data;
          if (res.data) {
            // åˆ¤æ–­æ˜¯å¦æœ‰æ›´å¤šï¼šè¯·æ±‚çš„æœ€åä¸€ä¸ªå’Œå½“å‰æœç´¢ç»“æœçš„æœ€åä¸€ä¸ªç›¸åŒ
            if (
              results[results.length - 1].name ===
              this.searchResult[this.searchResult.length - 1].bookname
            ) {
              wepy.hideLoading();
              wepy.showToast({
                title: "æ²¡æœ‰æ›´å¤šäº†!",
                icon: "none",
                duration: 1000
              });
            } else {
              for (let i = 0; i < results.length; i++) {
                let book = {};
                book.bookname = results[i].name;
                book.author = results[i].author;
                book.publishers = results[i].press;
                book.callno = results[i].callNumber;
                book.leftBookNum = results[i].numbers;
                book.marc_no = results[i].marc_no;
                this.searchResult.push(book);
                this.spinS.push({});
                this.showOffS.push({});
                this.isTapIndexS.push(false);
                this.hideS.push(true);
              }
              this.$apply();
              wepy.hideLoading();
            }
          }
        });
      }
    },
    async showBookDetails(e) {
      let that = this;
      let name = e.currentTarget.dataset.name;
      let index = e.currentTarget.dataset.index;
      wepy.showLoading({
        title: "åŠ è½½ä¸­"
      });
      async function addDetails(name, index) {
        return new Promise((resolve, reject) => {
          bookStoreContent(name)
            .then(res => {
              let detail = res.data.data;
              that.lendBooks[index].category = detail.type;
              that.lendBooks[index].ISBN = detail.isbn;
              that.lendBooks[index].price = detail.price;
              that.lendBooks[index].summary = detail.summary;
              that.lendBooks[index].author = detail.author;
              that.lendBooks[index].publishers = detail.press;
              that.$apply();
              return that.lendBooks[index];
            })
            .then(res => {
              let query = wepy.createSelectorQuery();
              let book = "#lendbook" + index;
              query.select(book).boundingClientRect();
              that.isTapIndex[index] = true;
              that.hide[index] = false;
              that.$apply();
              query.exec(function(res) {
                let hh = (750 / that.winWidth) * res[0].height + 30;
                let showOff = wepy.createAnimation({
                  duration: 300,
                  timingFunction: "ease"
                });
                let spin = wepy.createAnimation({
                  duration: 300,
                  timingFunction: "ease"
                });
                showOff.height(hh + "rpx").step();
                spin.rotate(-180).step();
                that.showOff[index] = showOff;
                that.spin[index] = spin;
                that.$apply();
              });
              that.$apply();
            });
          that.$apply();
          resolve(that.lendBooks[index]);
        });
      }
      await addDetails(name, index);
      wepy.hideLoading();
    },
    hideBookDetails(e) {
      const { index } = e.currentTarget.dataset;
      this.isTapIndex[index] = false;
      this.hide[index] = true;
      let query = wepy.createSelectorQuery();
      let book = "#lendbook" + index;
      query.select(book).boundingClientRect();
      query.exec(res => {
        let showOff = wepy.createAnimation({
          duration: 300,
          timingFunction: "ease"
        });
        let spin = wepy.createAnimation({
          duration: 300,
          timingFunction: "ease"
        });
        showOff.height(0).step();
        spin.rotate(-360).step();
        this.spin[index] = spin.export();
        this.showOff[index] = showOff.export();
        this.$apply();
      });
      this.$apply();
    },
    async showSearchedBookDetails(e) {
      let that = this;
      // è·å–è¯·æ±‚æ•°æ®åå†å±•å¼€
      let name = e.currentTarget.dataset.name;
      let index = e.currentTarget.dataset.index;
      wepy.showLoading({
        title: "åŠ è½½ä¸­"
      });
      function addDetails(name, index) {
        return new Promise((resolve, reject) => {
          // å‘é€è¯·æ±‚, ifæ‰§è¡ŒæˆåŠŸï¼Œreslove()
          bookStoreContent(name)
            .then(res => {
              let detail = res.data.data;
              that.searchResult[index].category = detail.type;
              that.searchResult[index].ISBN = detail.ISBN;
              that.searchResult[index].price = detail.price;
              that.searchResult[index].summary = detail.summary;
              that.searchResult[index].author = detail.author;
              that.searchResult[index].publishers = detail.press;
              that.searchResult[index].ISBN = detail.isbn;
              that.searchResult[index].positionDetail = [];
              let positionDetail = detail.bookPositionModels;
              for (let i = 0; i < positionDetail.length; i++) {
                let pos = {};
                pos.position = positionDetail[i].position;
                pos.callno = positionDetail[i].callNumber;
                pos.status = positionDetail[i].status;
                that.searchResult[index].positionDetail.push(pos);
              }
              that.$apply();
              return that.searchResult[index];
            })
            .then(res => {
              let query = wepy.createSelectorQuery();
              let book = "#searchbook" + index;
              query.select(book).boundingClientRect();
              that.isTapIndexS[index] = true;
              that.hideS[index] = false;
              that.$apply();
              query.exec(function(res) {
                that.$apply();
                let hh = (750 / that.winWidth) * res[0].height + 30;
                let showOff = wepy.createAnimation({
                  duration: 300,
                  timingFunction: "ease"
                });
                let spin = wepy.createAnimation({
                  duration: 300,
                  timingFunction: "ease"
                });
                showOff.height(hh + "rpx").step();
                spin.rotate(-180).step();
                that.spinS[index] = spin.export();
                that.showOffS[index] = showOff.export();
                that.$apply();
              });
              that.$apply();
            });
          that.$apply();
          resolve(that.searchResult[index]);
        });
      }
      await addDetails(name, index);
      wepy.hideLoading();
    },
    hideSearchedBookDetails(e) {
      let that = this;
      let index = e.currentTarget.dataset.index;
      that.isTapIndexS[index] = false;
      that.hideS[index] = true;
      let query = wepy.createSelectorQuery();
      let book = "#searchbook" + index;
      query.select(book).boundingClientRect();
      query.exec(function(res) {
        let showOff = wepy.createAnimation({
          duration: 300,
          timingFunction: "ease"
        });
        let spin = wepy.createAnimation({
          duration: 300,
          timingFunction: "ease"
        });
        showOff.height(0).step();
        spin.rotate(-360).step();
        that.spinS[index] = spin.export();
        that.showOffS[index] = showOff.export();
        that.$apply();
      });
      that.$apply();
    },
    /**
     * ç»­å€Ÿ => å·²å€Ÿçš„ä¹¦ç±ğŸ“š
     */
    async renewBooks(e) {
      let that = this;
      wepy.showLoading();
      await bookStoreAgain()
        .then(res => {
          let results = res.data.data;
          if (res.data) {
            for (let i = 0; i < results.length; i++) {
              let bar = results[i].bar;
              let status = results[i].result;
              let tip = results[i].tip;
              for (let j = 0; j < that.lendBooks.length; j++) {
                // åŒ¹é…å›¾ä¹¦çš„æ¡å½¢ç 
                if (bar === that.lendBooks[j].bar) {
                  if (!status) {
                    return tip;
                  }
                }
              }
            }
          }
          return "200";
        })
        .then(res => {
          // è¯·æ±‚å·²å€Ÿä¹¦ç›®è·å–that.lendBooks[j].leftDDL å’Œ that.lendBooks[j].newDDL
          if (res === "200") {
            alreadyBorrowBooksSum().then(res => {
              let results = res.data.data;
              for (let i = 0; i < results.length; i++) {
                let bar = results[i].bar;
                // æ­¤æ—¶è·å–çš„deadlineä¸ºæ–°çš„åº”è¿˜æ—¥æœŸ
                let newDDL = results[i].deadline;
                let leftDDL = results[i].leftTime;
                let renew = results[i].renew_conut;
                for (let j = 0; j < that.lendBooks.length; j++) {
                  if (bar === that.lendBooks[j].bar) {
                    that.lendBooks[j].DDL = newDDL;
                    that.lendBooks[j].leftDDL = leftDDL;
                    that.lendBooks[j].renew = renew;
                  }
                }
              }
              wepy.hideLoading();
              wepy.showToast({
                title: "ç»­å€ŸæˆåŠŸ",
                icon: "success",
                duration: 2000
              });
              that.$apply();
              // resolve((that.renewAll = false));
            });
          } else {
            wepy.showToast({
              title: res,
              icon: "none",
              duration: 2000
            });
          }
        });
      that.$apply();
    },
    clearPlaceHolder(e) {
      this.hasInput = true;
      this.$apply();
    },
    getPlaceHolder(e) {
      this.hasInput = false;
      this.$apply();
    },
    search(e) {
      // ä»…ä»…æ”¹å˜palceholder
      if (e.detail.value !== "") {
        this.hasInput = true;
      } else this.hasInput = false;
      this.$apply();
    },
    confirmSearch(e) {
      const { value } = e.detail;
      this.searchResult = [];
      this.$apply();
      this.find(value);
      this.$apply();
    },
    goToRecomened(e) {
      wepy.navigateTo({
        url: "library-recommened"
      });
    },
    quickSearch(e) {
      const { name } = e.target.dataset;
      this.searchResult = [];
      // this.$apply();
      this.find(name);
      this.$apply();
    },
    bindCardPassword(e) {
      this.bindInputPassword = e.detail.value;
    },
    async bindHandle() {
      await changeSecretCode(
        wepy.getStorageSync("User").studentId,
        this.bindInputPassword,
        "0"
      ).then(res => {
        if (res.data && res.data.data) {
          // ç»‘å®šæˆåŠŸ
          this.placeholder = "";
          this.bindModalVisible = false;
          this.init();
        } else {
          wepy.showModal({
            content: "å¯†ç é”™è¯¯",
            confirmText: "çŸ¥é“äº†",
            showCancel: false,
            confirmColor: "#353535"
          });
        }
      });
    }
  };

  /**
   * æŸ¥è¯¢ä¹¦ç±æ¥å£
   */
  find(e) {
    let name = e;
    this.searchBookName = name;
    // æœç´¢"æˆ‘è¦èè´­"åˆ™æ˜¾ç¤ºèè´­ï¼Œå¦åˆ™æ˜¾ç¤ºæœç´¢ç»“æœ
    if (name === "æˆ‘è¦èè´­") {
      this.hasResult = false;
      this.emptyResult = true;
    } else {
      this.emptyResult = false;
      this.hasResult = true;
    }
    // è¯·æ±‚æ•°æ®
    wepy.showLoading({
      title: "åŠ è½½ä¸­"
    });
    librarySearch(this.searchBookName, "1").then(res => {
      this.searchedPage = 1;
      const {
        data: [...results],
        success
      } = res.data;
      if (success) {
        if (results.length === 0) {
          this.hasResult = false;
          this.emptyResult = true;
          this.searchResult = [];
          this.$apply();
        } else {
          for (let i = 0; i < results.length; i++) {
            let book = {};
            book.bookname = results[i].name;
            book.author = results[i].author;
            book.publishers = results[i].press;
            book.callno = results[i].callNumber;
            book.leftBookNum = results[i].numbers;
            book.marc_no = results[i].marc_no;
            this.searchResult.push(book);
            this.spinS.push({});
            this.showOffS.push({});
            this.isTapIndexS.push(false);
            this.hideS.push(true);
          }
          this.$apply();
        }
        wepy.hideLoading();
      }
    });
    this.$apply();
  }
  watch = {
    currentTab(newValue, oldValue) {
      let lineAnimation = wepy.createAnimation({
        duration: 500,
        timingFunction: "ease-in-out"
      });
      let leftWidth = 40;
      if (newValue === 0) {
        leftWidth = 40;
      } else if (newValue === 1) {
        leftWidth = 312;
      } else {
        leftWidth = 590;
      }
      lineAnimation.left(leftWidth + "rpx").step();
      this.animationNav = lineAnimation.export();
      this.$apply();
    },
    bindingVisible(newValue, oldValue) {
      if (!newValue) {
        this.onLoadRequests();
      }
    }
  };
  computed = {
    curBooksNum() {
      return this.lendBooks.length;
    }
  };

  /**
   * è·å–æ¬ æ¬¾é‡‘é¢ï¼ˆéœ€æ¨¡å—ç»‘å®šåä½¿ç”¨ï¼‰finish
   */
  getArrearMoney() {
    bookArrears().then(res => {
      if (res.data) {
        if (res.data.data.charAt(0) === ".") this.arrears = "0" + res.data.data;
        else this.arrears = res.data.data;
      }
      this.$apply();
    });
  }

  /**
   * è·å–æ€»å€Ÿé˜…ä¹¦æœ¬æ•°ï¼ˆéœ€æ¨¡å—ç»‘å®šåä½¿ç”¨ï¼‰finish, ä»…åœ¨æ­¤å¤„åˆ¤æ–­å¯†ç æ›´æ–°ã€‚
   */
  getHistoricalBorrowing() {
    historicalBorrow().then(res => {
      if (!res.data) {
        this.placeholder = "å›¾ä¹¦é¦†å¯†ç ï¼ˆé»˜è®¤å­¦å·ï¼‰";
        this.bindModalVisible = true;
        this.$apply();
      } else {
        this.totalBooksNumber = res.data.data;
      }
      this.$apply();
    });
  }

  /**
   * è·å–ç”¨æˆ·å·²å€Ÿä¹¦ç›®ï¼ˆéœ€æ¨¡å—ç»‘å®šåä½¿ç”¨ï¼‰
   */
  getAlreadyBorrowBooks() {
    alreadyBorrowBooksSum().then(res => {
      let results = res.data.data;
      this.lendBooks = [];
      this.$apply();
      if (res.data) {
        for (let i = 0; i < results.length; i++) {
          let lend = {};
          lend.bookname = results[i].name;
          lend.renew = results[i].renew_conut;
          lend.DDL = results[i].deadline;
          lend.leftDDL = results[i].leftTime;
          lend.marc_no = results[i].marc_no;
          lend.bar = results[i].bar;
          this.lendBooks.push(lend);
          this.spin.push({});
          this.showOff.push({});
          this.isTapIndex.push(false);
          this.hide.push(true);
        }
        this.$apply();
        for (let i = 0; i < this.lendBooks.length; i++) {
          if (this.lendBooks[i].leftDDL <= 0) {
            this.renewAll = false;
            break;
          } else if (
            parseInt(this.lendBooks[i].leftDDL) <= 10 &&
            this.lendBooks[i].renew === "0" &&
            parseInt(this.lendBooks[i].leftDDL) > 0
          ) {
            // ç»­å€Ÿæ¬¡æ•°ä¸º0ï¼Œä¸”å‰©ä½™å¤©æ•°å°äº10å¤§äº0å­˜åœ¨å¯å€Ÿå›¾ä¹¦ã€‚ç»­å€ŸæŒ‰é’®é«˜äº®
            this.renewAll = true;
            break;
          }
        }
      }
      this.$apply();
    });
  }

  /**
   * è·å–çƒ­é—¨æ¨è
   */
  getHotRecommandBooks() {
    wepy.showLoading({
      title: "åŠ è½½ä¸­"
    });
    hotBooks().then(res => {
      const { data } = res.data;
      data.map((item, index) => {
        this.recomends[index] = {
          name: item,
          id: index + 1
        };
      });
      this.$apply();
      wepy.hideLoading();
    });
  }

  /**
   * è·å–å‰©ä½™åº§ä½
   */
  queryOverplusSeats() {
    wepy.showLoading({
      title: "åŠ è½½ä¸­"
    });
    remainSeats().then(res => {
      let results = res.data.data;
      for (let i = 0; i < 4; i++) {
        this.floors[i].rooms = [];
        this.$apply();
      }
      for (let i = 0; i < results.length; i++) {
        let room = {};
        room.name = results[i].place;
        room.totalSeats = results[i].total;
        room.curSeats = results[i].available;
        if (results[i].location === "äºŒå±‚") {
          this.floors[0].rooms.push(room);
        } else if (results[i].location === "ä¸‰å±‚") {
          this.floors[1].rooms.push(room);
        } else if (results[i].location === "å››å±‚") {
          this.floors[2].rooms.push(room);
        } else if (results[i].location === "äº”å±‚") {
          this.floors[3].rooms.push(room);
        }
      }
      this.$apply();
      wepy.hideLoading();
    });
  }

  /**
   * é¡µé¢ç»‘å®šæ¨¡å—åçš„ä¸€äº›è¯·æ±‚
   */
  async onLoadRequests() {
    wepy.showLoading({
      title: "åŠ è½½ä¸­"
    });
    await this.getHistoricalBorrowing();
    await this.getAlreadyBorrowBooks();
    await this.getArrearMoney();
    wepy.hideLoading();
  }
  async onLoad(option) {
    wepy.getSystemInfo().then(res => {
      this.winWidth = parseInt(res.windowWidth);
      this.winHeight = parseInt(res.windowHeight);
      this.$apply();
    });
    this.token = wepy.getStorageSync("token");
    this.$apply();
    let userInfomations = wepy.getStorageSync("User");
    this.phoneNumber = userInfomations.nativeInformation.phoneNumber;
    this.studentId = userInfomations.nativeInformation.studentId;
    this.userId = userInfomations.nativeInformation.userId;
    // ç”¨äºæ¨¡å—ç»‘å®š
    // this.bindingDomainUserName = this.studentId;
    this.$apply();
    if (option.page === "search") {
      this.currentTab = 1;
    } else if (option.page === "seats") {
      this.currentTab = 2;
    } else {
      this.currentTab = 0;
      this.onLoadRequests();
    }
    this.$apply();
  }
}
</script>


<style lang="stylus" scoped>
.cover
  position fixed
  width 100vw
  height 100vh
  background rgb(0, 0, 0)
  opacity 0
  z-index 1000
.cover-modal
  position absolute
  margin 0 auto
  width 500rpx
  left 105rpx
  padding 20rpx
  top 40vh
  background #fff
  z-index 1000
  border-radius 10rpx
  font-size 28rpx
  text-align center
.swiper-tab
  display flex
  position relative
  justify-content space-between
  align-items center
  text-align center
  height 44rpx
  padding 0 40rpx
  padding-top 8.5rpx
  padding-bottom 24rpx
  border-bottom 2rpx solid #dddddd
  .swiper-tab-list
    font-size 30rpx
    color #353535
    transition color 0.5s
  .active
    color #39c9ff
  .swiper-line
    background-color #39c9ff
    width 120rpx
    height 5rpx
    border-radius 8rpx
    position absolute
    bottom 16rpx
    left 40rpx
.swiper-box
  .books-container
    .books-head
      width 750rpx
      height 300rpx
      text-align center
      background-position center
      background-image url('https://static.airbob.org/under-graduate/library_pic_banner.png')
      background-repeat no-repeat
      background-size contain
      color #fff
      display flex
      justify-content center
      align-items flex-end
      .books-num
        font-size 70rpx
        margin-right 30rpx
        margin-bottom 30rpx
      .books-cnt
        font-size 30rpx
        margin-bottom 40rpx
    .books-tip
      color #E64340
      font-size 24rpx
      width 250rpx
      margin-left 60rpx
      margin-top 20rpx
      margin-bottom 30rpx
      .books-question
        width 25rpx
        height 25rpx
        margin-left 10rpx
    .books-none-container
      width 750rpx
      height 700rpx
      padding-top 180rpx
      text-align center
      font-size 28rpx
      color #999CA0
      .books-none-img
        width 400rpx
        height 291rpx
        margin-bottom 50rpx
    .books-list
      display flex
      flex-direction column
      align-items center
      width 750rpx
      .book-container
        width 675rpx
        min-height 180rpx
        border-top 1rpx solid rgba(0, 0, 0, 0.1)
        border-right 1rpx solid rgba(0, 0, 0, 0.1)
        border-left 1rpx solid rgba(0, 0, 0, 0.1)
        border-radius 20rpx
        margin-bottom 29rpx
        display flex
        align-items center
        .book-info-all
          width 590rpx
          display flex
          flex-direction column
          align-items flex-start
          font-size 24rpx
          color #353535
          line-height 45rpx
          margin 30rpx 0rpx 30rpx 30rpx
          .book-name
            font-size 30rpx
            font-weight bold
        .button-updown
          width 35rpx
          height 20rpx
      .book-detail-container
        width 675rpx
        height 0
        overflow hidden
        border-right 1rpx solid rgba(0, 0, 0, 0.1)
        border-left 1rpx solid rgba(0, 0, 0, 0.1)
        border-radius 0 0 20rpx 20rpx
        font-size 24rpx
        color #353535
        margin-top -29rpx
        margin-bottom 29rpx
        z-index 1000
        .book-detail-info-all
          width 590rpx
          border-top 2rpx solid #dddddd
          display flex
          flex-direction column
          align-items flex-start
          line-height 45rpx
          margin 0rpx 30rpx 30rpx 30rpx
          padding-top 30rpx
    .button-renew
      background-repeat no-repeat
      background-position top center
      background-size 605rpx 80rpx
      width 605rpx
      height 80rpx
      font-size 30rpx
      text-align center
      line-height 80rpx
      color #fff
      margin 50rpx auto 15% auto
  .search-container
    .search-bar-container
      width 750rpx
      height 300rpx
      .search-bar
        height 60rpx
        font-size 30rpx
        position relative
        top 50%
        transform translateY(-50%)
        .search-placeholder-all
          color #999CA0
          text-align center
          height 60rpx
          width 630rpx
          position absolute
          top 12rpx
          left 50rpx
          z-index 2
          .search-icon
            width 25rpx
            height 25rpx
            display inline-block
          .search-placeholder
            height 60rpx
            padding 0 20rpx
            display inline-block
        .search-input
          height 60rpx
          width 630rpx
          margin 0 auto
          background #F5F5F5
          color #353535
          border-radius 60rpx
          padding 0 30rpx
    .search-recommend
      width 750rpx
      .search-recommend-title
        text-align center
        font-size 30rpx
        font-weight bolder
      .search-recommend-content
        .search-recommend-book
          width 630rpx
          text-align center
          margin 30rpx auto
          color #39c9ff
          font-size 24rpx
          line-height 1.5em
    .search-no-result
      font-size 30rpx
      display flex
      flex-direction column
      justify-content center
      .search-no-result-pic
        width 400rpx
        height 300rpx
        margin 100rpx auto
      .search-no-result-tips
        color #999CA0
        width 630rpx
        height 60rpx
        margin 10rpx auto
      .search-no-result-recom
        background-color #39c9ff
        width 260rpx
        height 60rpx
        margin 30rpx auto
        border-radius 8rpx
        text-align center
        line-height 60rpx
        color #fff
    .search-result
      width 750rpx
      margin-bottom 120rpx
      .search-result-container
        width 675rpx
        min-height 180rpx
        border-radius 20rpx
        margin 29rpx auto
        border-top 1rpx solid rgba(0, 0, 0, 0.1)
        border-right 1rpx solid rgba(0, 0, 0, 0.1)
        border-left 1rpx solid rgba(0, 0, 0, 0.1)
        font-size 24rpx
        color #353535
        display flex
        align-items center
        .search-info-all
          width 590rpx
          display flex
          flex-direction column
          align-items flex-start
          font-size 24rpx
          color #353535
          line-height 45rpx
          margin 30rpx 0rpx 30rpx 30rpx
          .search-book-name
            font-size 30rpx
            font-weight bold
        .search-button-updown
          width 34rpx
          height 20rpx
      .search-detail-container
        width 675rpx
        height 0rpx
        overflow hidden
        border-right 1rpx solid rgba(0, 0, 0, 0.1)
        border-left 1rpx solid rgba(0, 0, 0, 0.1)
        border-radius 0 0 20rpx 20rpx
        font-size 24rpx
        color #353535
        margin -29rpx auto 29rpx auto
        .search-detail-info-all
          width 590rpx
          border-top 2rpx solid #dddddd
          display flex
          flex-direction column
          align-items flex-start
          line-height 45rpx
          margin 0rpx 30rpx 30rpx 30rpx
          padding-top 30rpx
          .search-info-divide
            width 590rpx
            border 1rpx dashed #dddddd
            margin-top 10rpx
            margin-bottom 30rpx
  .seats-container
    .seats-head
      width 750rpx
      height 300rpx
      background-position center
      background-image url('https://static.airbob.org/under-graduate/library_seat_banner.png')
      background-repeat no-repeat
      background-size contain
    .seats-divide
      width 750rpx
      height 20rpx
      background-color rgb(245, 245, 245)
.bind-container
  display flex
  flex-direction column
  align-items center
  background-image url('https://static.airbob.org/under-graduate/model_pic_password.png')
  background-repeat no-repeat
  height 485rpx
  border-radius 30rpx
  background-size cover
  .bind-input
    font-size 26rpx
    margin 221rpx 0 56rpx
    width 438rpx
    border-bottom 2rpx solid #999CA0
  .bind-button
    margin-top 26rpx
    background-color #6AE4FF
    text-align center
    width 410rpx
    height 80rpx
    line-height 80rpx
    color #ffffff
    border-radius 50px
</style>
